#!/bin/bash

# ========================================
# Script de integra√ß√£o de relat√≥rios HTML para Security Analyzer Tool
# ========================================

# Importar fun√ß√µes do script de relat√≥rios HTML
source "$(dirname "$(readlink -f "$0")")/html_report.sh"

# Fun√ß√£o para capturar a sa√≠da de uma an√°lise e gerar um relat√≥rio HTML
capture_and_report() {
    local analysis_type="$1"
    local target="$2"
    local analysis_function="$3"
    
    # Criar arquivo tempor√°rio para capturar a sa√≠da
    local temp_output=$(mktemp)
    
    # Executar a fun√ß√£o de an√°lise e capturar a sa√≠da
    $analysis_function "$target" | tee "$temp_output"
    
    # Gerar relat√≥rio HTML com a sa√≠da capturada
    local analysis_text=$(cat "$temp_output")
    local report_file=$(generate_html_report "$analysis_type" "$target" "$analysis_text")
    
    # Remover arquivo tempor√°rio
    rm -f "$temp_output"
    
    # Perguntar se deseja abrir o relat√≥rio no navegador
    echo
    echo -e "${CYAN}Relat√≥rio HTML gerado: $report_file${NC}"
    echo -n "Deseja abrir o relat√≥rio no navegador? (s/n): "
    read -r open_browser
    
    if [[ "$open_browser" == "s" || "$open_browser" == "S" ]]; then
        open_report "$report_file"
    fi
}

# Fun√ß√£o para analisar arquivo com relat√≥rio HTML
analyze_file_with_report() {
    local file_path="$1"
    capture_and_report "Arquivo" "$file_path" "analyze_file_internal"
}

# Fun√ß√£o para analisar URL com relat√≥rio HTML
analyze_url_with_report() {
    local url="$1"
    capture_and_report "URL" "$url" "analyze_url_internal"
}

# Fun√ß√£o para analisar dom√≠nio com relat√≥rio HTML
analyze_domain_with_report() {
    local domain="$1"
    capture_and_report "Dom√≠nio" "$domain" "analyze_domain_internal"
}

# Fun√ß√£o para analisar hash com relat√≥rio HTML
analyze_hash_with_report() {
    local hash="$1"
    capture_and_report "Hash" "$hash" "analyze_hash_internal"
}

# Fun√ß√£o para analisar email com relat√≥rio HTML
analyze_email_with_report() {
    local email="$1"
    capture_and_report "Email" "$email" "analyze_email_internal"
}

# Fun√ß√£o para analisar cabe√ßalho de email com relat√≥rio HTML
analyze_header_with_report() {
    local header_file="$1"
    capture_and_report "Cabe√ßalho de Email" "$header_file" "analyze_header_internal"
}

# Fun√ß√£o para analisar IP com relat√≥rio HTML
analyze_ip_with_report() {
    local ip="$1"
    capture_and_report "IP" "$ip" "analyze_ip_internal"
}

# Fun√ß√£o para listar relat√≥rios gerados
list_reports() {
    local reports_dir="$HOME/.security_analyzer/reports"
    
    echo -e "${CYAN}üìã RELAT√ìRIOS GERADOS${NC}"
    echo
    
    if [[ ! -d "$reports_dir" ]]; then
        echo "‚ùå Diret√≥rio de relat√≥rios n√£o encontrado."
        echo "Nenhum relat√≥rio foi gerado ainda."
        return
    fi
    
    # Contar relat√≥rios
    local report_count=$(find "$reports_dir" -name "*.html" -type f 2>/dev/null | wc -l)
    
    if [[ $report_count -eq 0 ]]; then
        echo "üìÑ Nenhum relat√≥rio encontrado."
        echo "Execute uma an√°lise para gerar relat√≥rios."
        return
    fi
    
    echo "üìä Total de relat√≥rios: $report_count"
    echo
    echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${BLUE}‚îÇ${NC} ID do Relat√≥rio          ‚îÇ Data       ‚îÇ Tipo        ‚îÇ Status      ‚îÇ Alvo     ${BLUE}‚îÇ${NC}"
    echo -e "${BLUE}‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§${NC}"
    
    # Listar relat√≥rios ordenados por data (mais recente primeiro)
    local counter=1
    for report in $(find "$reports_dir" -name "*.html" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | cut -d' ' -f2-); do
        if [[ ! -f "$report" ]]; then
            continue
        fi
        
        local report_name=$(basename "$report" .html)
        local report_date=$(echo "$report_name" | cut -d'-' -f2)
        local report_date_formatted="${report_date:6:2}/${report_date:4:2}/${report_date:0:4}"
        
        # Extrair informa√ß√µes do arquivo HTML
        local analysis_type=$(grep -o '<strong>Tipo de An√°lise:</strong> [^<]*' "$report" 2>/dev/null | sed 's/<strong>Tipo de An√°lise:<\/strong> //' | head -1)
        local target=$(grep -o '<strong>Alvo:</strong> [^<]*' "$report" 2>/dev/null | sed 's/<strong>Alvo:<\/strong> //' | head -1)
        local overall_status=$(grep -o 'Status Geral</h3>[^<]*<p>[^<]*' "$report" 2>/dev/null | sed 's/.*<p>//' | head -1)
        
        # Valores padr√£o se n√£o encontrar
        [[ -z "$analysis_type" ]] && analysis_type="N/A"
        [[ -z "$target" ]] && target="N/A"
        [[ -z "$overall_status" ]] && overall_status="N/A"
        
        # Truncar strings longas
        [[ ${#target} -gt 15 ]] && target="${target:0:12}..."
        [[ ${#analysis_type} -gt 10 ]] && analysis_type="${analysis_type:0:7}..."
        [[ ${#overall_status} -gt 10 ]] && overall_status="${overall_status:0:7}..."
        
        # Colorir status
        local status_color=""
        case "$overall_status" in
            *"Limpo"*|*"Seguro"*)
                status_color="${GREEN}"
                ;;
            *"Suspeito"*)
                status_color="${YELLOW}"
                ;;
            *"Malicioso"*|*"Perigoso"*)
                status_color="${RED}"
                ;;
            *)
                status_color="${NC}"
                ;;
        esac
        
        printf "${BLUE}‚îÇ${NC} %-2d %-18s ‚îÇ %-10s ‚îÇ %-11s ‚îÇ %s%-11s${NC} ‚îÇ %-8s ${BLUE}‚îÇ${NC}\n" \
            "$counter" "$report_name" "$report_date_formatted" "$analysis_type" \
            "$status_color" "$overall_status" "$target"
        
        ((counter++))
        
        # Limitar a 20 relat√≥rios por p√°gina
        if [[ $counter -gt 20 ]]; then
            echo -e "${BLUE}‚îÇ${NC} ... e mais $((report_count - 20)) relat√≥rios                                    ${BLUE}‚îÇ${NC}"
            break
        fi
    done
    
    echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
    echo
    
    # Menu de op√ß√µes
    echo -e "${CYAN}Op√ß√µes:${NC}"
    echo "  [1-$counter] Abrir relat√≥rio espec√≠fico"
    echo "  [a] Abrir todos os relat√≥rios recentes (√∫ltimos 5)"
    echo "  [s] Iniciar servidor web"
    echo "  [d] Excluir relat√≥rio"
    echo "  [c] Limpar todos os relat√≥rios"
    echo "  [0] Voltar"
    echo
    echo -n "Escolha uma op√ß√£o: "
    read -r choice
    
    case "$choice" in
        [1-9]|[1-2][0-9])
            # Abrir relat√≥rio espec√≠fico
            local selected_report=$(find "$reports_dir" -name "*.html" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | sed -n "${choice}p" | cut -d' ' -f2-)
            if [[ -f "$selected_report" ]]; then
                echo "Abrindo relat√≥rio: $(basename "$selected_report")"
                open_report "$selected_report"
            else
                echo "‚ùå Relat√≥rio n√£o encontrado."
            fi
            ;;
        "a"|"A")
            # Abrir √∫ltimos 5 relat√≥rios
            echo "Abrindo os 5 relat√≥rios mais recentes..."
            local count=0
            for report in $(find "$reports_dir" -name "*.html" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | cut -d' ' -f2-); do
                if [[ $count -lt 5 ]]; then
                    open_report "$report"
                    sleep 1  # Pequena pausa entre aberturas
                    ((count++))
                else
                    break
                fi
            done
            ;;
        "s"|"S")
            # Iniciar servidor web
            start_report_server
            echo "Servidor iniciado. Acesse: http://localhost:8080/"
            ;;
        "d"|"D")
            # Excluir relat√≥rio espec√≠fico
            echo -n "Digite o n√∫mero do relat√≥rio para excluir: "
            read -r del_choice
            local del_report=$(find "$reports_dir" -name "*.html" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | sed -n "${del_choice}p" | cut -d' ' -f2-)
            if [[ -f "$del_report" ]]; then
                echo -n "Tem certeza que deseja excluir $(basename "$del_report")? (s/n): "
                read -r confirm
                if [[ "$confirm" == "s" || "$confirm" == "S" ]]; then
                    rm -f "$del_report"
                    echo "‚úÖ Relat√≥rio exclu√≠do com sucesso."
                else
                    echo "Opera√ß√£o cancelada."
                fi
            else
                echo "‚ùå Relat√≥rio n√£o encontrado."
            fi
            ;;
        "c"|"C")
            # Limpar todos os relat√≥rios
            echo -n "‚ö†Ô∏è  Tem certeza que deseja excluir TODOS os relat√≥rios? (s/n): "
            read -r confirm
            if [[ "$confirm" == "s" || "$confirm" == "S" ]]; then
                rm -f "$reports_dir"/*.html 2>/dev/null
                echo "‚úÖ Todos os relat√≥rios foram exclu√≠dos."
            else
                echo "Opera√ß√£o cancelada."
            fi
            ;;
        "0")
            return
            ;;
        *)
            echo "‚ùå Op√ß√£o inv√°lida."
            ;;
    esac
}

# Fun√ß√£o para mostrar detalhes de um relat√≥rio espec√≠fico
show_report_details() {
    local report_file="$1"
    
    if [[ ! -f "$report_file" ]]; then
        echo "‚ùå Relat√≥rio n√£o encontrado: $report_file"
        return 1
    fi
    
    local report_name=$(basename "$report_file" .html)
    
    echo -e "${CYAN}üìÑ DETALHES DO RELAT√ìRIO${NC}"
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo
    
    # Extrair informa√ß√µes do HTML
    local analysis_type=$(grep -o '<strong>Tipo de An√°lise:</strong> [^<]*' "$report_file" 2>/dev/null | sed 's/<strong>Tipo de An√°lise:<\/strong> //' | head -1)
    local target=$(grep -o '<strong>Alvo:</strong> [^<]*' "$report_file" 2>/dev/null | sed 's/<strong>Alvo:<\/strong> //' | head -1)
    local timestamp=$(grep -o '<strong>Timestamp:</strong> [^<]*' "$report_file" 2>/dev/null | sed 's/<strong>Timestamp:<\/strong> //' | head -1)
    local overall_status=$(grep -o 'Status Geral</h3>[^<]*<p>[^<]*' "$report_file" 2>/dev/null | sed 's/.*<p>//' | head -1)
    local threat_level=$(grep -o 'N√≠vel de Amea√ßa</h3>[^<]*<p>[^<]*' "$report_file" 2>/dev/null | sed 's/.*<p>//' | head -1)
    local sources_count=$(grep -o 'Fontes Consultadas</h3>[^<]*<p>[^<]*' "$report_file" 2>/dev/null | sed 's/.*<p>//' | head -1)
    
    # Informa√ß√µes b√°sicas
    echo -e "${YELLOW}ID do Relat√≥rio:${NC} $report_name"
    echo -e "${YELLOW}Tipo de An√°lise:${NC} ${analysis_type:-N/A}"
    echo -e "${YELLOW}Alvo Analisado:${NC} ${target:-N/A}"
    echo -e "${YELLOW}Data/Hora:${NC} ${timestamp:-N/A}"
    echo
    
    # Status com cores
    local status_color=""
    case "$overall_status" in
        *"Limpo"*|*"Seguro"*)
            status_color="${GREEN}"
            ;;
        *"Suspeito"*)
            status_color="${YELLOW}"
            ;;
        *"Malicioso"*|*"Perigoso"*)
            status_color="${RED}"
            ;;
        *)
            status_color="${NC}"
            ;;
    esac
    
    echo -e "${YELLOW}Status Geral:${NC} ${status_color}${overall_status:-N/A}${NC}"
    echo -e "${YELLOW}N√≠vel de Amea√ßa:${NC} ${threat_level:-N/A}"
    echo -e "${YELLOW}Fontes Consultadas:${NC} ${sources_count:-N/A}"
    echo
    
    # Informa√ß√µes do arquivo
    local file_size=$(du -h "$report_file" 2>/dev/null | cut -f1)
    local file_date=$(stat -c %y "$report_file" 2>/dev/null | cut -d'.' -f1)
    
    echo -e "${BLUE}Informa√ß√µes do Arquivo:${NC}"
    echo -e "  Tamanho: ${file_size:-N/A}"
    echo -e "  Criado em: ${file_date:-N/A}"
    echo -e "  Localiza√ß√£o: $report_file"
    echo
    
    # Op√ß√µes
    echo -e "${CYAN}Op√ß√µes:${NC}"
    echo "  [1] üåê Abrir no navegador"
    echo "  [2] üìã Copiar caminho do arquivo"
    echo "  [3] üóëÔ∏è  Excluir este relat√≥rio"
    echo "  [0] üîô Voltar"
    echo
    echo -n "Escolha uma op√ß√£o: "
    read -r choice
    
    case "$choice" in
        1)
            open_report "$report_file"
            ;;
        2)
            echo "$report_file" | xclip -selection clipboard 2>/dev/null || echo "Caminho: $report_file"
            echo "‚úÖ Caminho copiado (ou exibido acima)"
            ;;
        3)
            echo -n "‚ö†Ô∏è  Tem certeza que deseja excluir este relat√≥rio? (s/n): "
            read -r confirm
            if [[ "$confirm" == "s" || "$confirm" == "S" ]]; then
                rm -f "$report_file"
                echo "‚úÖ Relat√≥rio exclu√≠do com sucesso."
                return 0
            else
                echo "Opera√ß√£o cancelada."
            fi
            ;;
        0)
            return 0
            ;;
        *)
            echo "‚ùå Op√ß√£o inv√°lida."
            ;;
    esac
    
    echo
    echo -n "Pressione Enter para continuar..."
    read
}
manage_reports() {
    while true; do
        echo -e "${CYAN}"
        cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                         GERENCIAMENTO DE RELAT√ìRIOS                         ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
        echo -e "${NC}"
        echo "  [1] üìã Listar Relat√≥rios        - Ver relat√≥rios gerados"
        echo "  [2] üåê Iniciar Servidor         - Iniciar servidor web"
        echo "  [3] üõë Parar Servidor           - Parar servidor web"
        echo "  [4] üóëÔ∏è  Excluir Relat√≥rio        - Remover relat√≥rio espec√≠fico"
        echo "  [5] üóëÔ∏è  Excluir Todos            - Remover todos os relat√≥rios"
        echo
        echo "  [0] üîô Voltar                   - Retornar ao menu principal"
        echo
        echo -n "Escolha uma op√ß√£o: "
        read -r option
        
        case "$option" in
            1)
                list_reports
                ;;
            2)
                start_report_server
                ;;
            3)
                stop_report_server
                ;;
            4)
                echo -n "Digite o ID do relat√≥rio a ser exclu√≠do: "
                read -r report_id
                if [[ -n "$report_id" && -f "$HOME/.security_analyzer/reports/$report_id.html" ]]; then
                    rm -f "$HOME/.security_analyzer/reports/$report_id.html"
                    echo "Relat√≥rio exclu√≠do com sucesso."
                else
                    echo "Relat√≥rio n√£o encontrado."
                fi
                ;;
            5)
                echo -n "Tem certeza que deseja excluir TODOS os relat√≥rios? (s/n): "
                read -r confirm
                if [[ "$confirm" == "s" || "$confirm" == "S" ]]; then
                    rm -f "$HOME/.security_analyzer/reports"/*.html
                    echo "Todos os relat√≥rios foram exclu√≠dos."
                fi
                ;;
            0)
                return
                ;;
            *)
                echo "Op√ß√£o inv√°lida."
                ;;
        esac
        
        echo
        echo -n "Pressione Enter para continuar..."
        read
    done
}
